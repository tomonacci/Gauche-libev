srcdir      = @srcdir@
VPATH       = $(srcdir)
top_builddir = @top_builddir@
top_srcdir   = @top_srcdir@

REF = gauche-libev-ref
MANPAGES = gosh.1 gauche-config.1 gauche-install.1 gauche-package.1 \
           gauche-cesconv.1
EXTRACTED = $(REF)e.texi $(REF)j.texi \
	    gauche-deve.texi gauche-devj.texi
GENERATED = Makefile $(MANPAGES)
GOSH = @GOSH@
INSTALL = @INSTALL@
MKINSTDIR = $(top_srcdir)/mkinstalldirs
MAKEINFO = @MAKEINFO@
GZIP_PROGRAM = @GZIP_PROGRAM@

TEXIS = $(REF).texi

# Manual page destination.  Default @mandir@ doesn't include 'share'
# in the path, so I redefine it---a user can still override it by
# make mandir=wherever
prefix      = @prefix@
datadir     = @datadir@
datarootdir = @datarootdir@
mandir      = @mandir@
infodir     = @infodir@

DESTDIR =

all: info

install: all
	if test ! -d $(DESTDIR)$(mandir)/man1; then $(MKINSTDIR) $(DESTDIR)$(mandir)/man1; fi
	$(INSTALL) -m 444 $(MANPAGES) $(DESTDIR)$(mandir)/man1
	if test ! -d $(DESTDIR)$(infodir); then $(MKINSTDIR) $(DESTDIR)$(infodir); fi
	if test -f $(REF)e.info.gz -o -f $(REF)j.info.gz; then \
	  for info in *.info*; do \
	    $(INSTALL) -m 444 $$info $(DESTDIR)$(infodir)/; \
	  done; \
	fi

uninstall:
	(cd $(mandir)/man1; rm -f $(MANPAGES))
	(cd $(infodir); \
	 if test -f $(REF)e.info -o -f $(REF)e.info.gz; \
	   then rm -rf $(REF)e.*; \
	 fi; \
	 if test -f $(REF)j.info -o -f $(REF)j.info.gz; \
	   then rm -rf $(REF)j.*; \
	 fi)

pre-package : texi

check :

test :

texi : $(REF)e.texi $(REF)j.texi

html : $(REF)e.html $(REF)j.html

htmls : $(REF)e_toc.html $(REF)j_toc.html

dvi : $(REF)e.dvi

pdf : $(REF)e.pdf

info : $(REF)e.info.gz $(REF)j.info.gz

# special rule to regenerate srfis.tex in case srfis.scm is modified.
srfis.texi : $(top_builddir)/src/srfis.scm
	cd $(top_builddir)/src; $(MAKE) libsrfis.scm

$(REF)e.html : $(REF)e.texi
	texi2html --number $(REF)e.texi

$(REF)e_toc.html : $(REF)e.texi
	texi2html --split section --number $(REF)e.texi

$(REF)e.dvi : $(REF)e.texi
	texi2dvi $(REF)e.texi

$(REF)e.pdf : $(REF)e.texi
	pdftex $(REF)e.texi
	texindex $(REF)e.??
	pdftex $(REF)e.texi

$(REF)e.texi : $(TEXIS) extract
	$(GOSH) $(srcdir)/extract -en -o $(REF)e.texi $(srcdir)/$(REF).texi

$(REF)e.info.gz : $(REF)e.texi
	if test X$(MAKEINFO) != X -a X$(GZIP_PROGRAM) != X; then \
	  env LANG=C $(MAKEINFO) --no-warn $(REF)e.texi; \
	  rm -rf $(REF)e.info*.gz; \
	  $(GZIP_PROGRAM) $(REF)e.info $(REF)e.info-[0-9]*; \
	fi

$(REF)j.html : $(REF)j.texi
	texi2html --init-file=$(srcdir)/ja-init.pl --number $(REF)j.texi

$(REF)j_toc.html : $(REF)j.texi
	texi2html --init-file=$(srcdir)/ja-init.pl --split section --number $(REF)j.texi
	for f in $(REF)j*.html; do \
	  sed 's/^<body lang="en"/<body lang="ja"/' $$f > $$f.t && mv $$f.t $$f; \
	done

$(REF)j.dvi : $(REF)j.texi
	texi2dvi $(REF)j.texi

$(REF)j.pdf : $(REF)j.texi
	pdftex $(REF)j.texi

$(REF)j.texi : $(TEXIS) extract
	$(GOSH) $(srcdir)/extract -jp -o $(REF)j.texi $(srcdir)/$(REF).texi

$(REF)j.info.gz : $(REF)j.texi
	if test X$(MAKEINFO) != X -a X$(GZIP_PROGRAM) != X; then \
	  env LANG=C $(MAKEINFO) --no-warn $(REF)j.texi; \
	  rm -rf $(REF)j.info*.gz; \
	  $(GZIP_PROGRAM) $(REF)j.info $(REF)j.info-[0-9]*; \
	fi

gauche-deve.texi : gauche-dev.texi extract
	$(GOSH) $(srcdir)/extract -en -o gauche-deve.texi gauche-dev.texi

gauche-deve.html : gauche-deve.texi
	texi2html --number gauche-deve.texi

gauche-deve.info.gz : gauche-deve.texi
	if test X$(MAKEINFO) != X -a X$(GZIP_PROGRAM) != X; then \
	  env LANG=C $(MAKEINFO) --no-warn gauche-deve.texi; \
	  rm -rf gauche-deve.info*.gz; \
	  $(GZIP_PROGRAM) gauche-deve.info gauche-deve.info-[0-9]*; \
	fi

gauche-deve.pdf : gauche-deve.texi
	pdftex gauche-deve.texi
	texindex gauche-deve.??
	pdftex gauche-deve.texi

clean:
	rm -rf core *~ *.aux *.cl *.cls *.cp *.cps *.fn *.fns *.ky *.kys \
               *.log *.md *.mds \
	       *.pg *.pgs *.toc *.tp *.tps *.vr *.vrs *.pdf *.dvi *.info* \
	       $(EXTRACTED)

distclean : clean
	rm -rf $(GENERATED)

maintainer-clean : clean
	rm -f $(REF)*.html $(REF)*.dvi gauche-dev*.html gauche-dev*.dvi Makefile $(GENERATED)
